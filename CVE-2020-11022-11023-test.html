<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CVE-2020-11022 & CVE-2020-11023 XSS Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 50px auto; 
            padding: 20px;
        }
        .test-section { 
            border: 2px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
        }
        .vulnerable { border-color: #ff4444; background: #fff5f5; }
        .fixed { border-color: #44ff44; background: #f5fff5; }
        h2 { margin-top: 0; }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; color: #155724; }
        .danger { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        code { 
            background: #f4f4f4; 
            padding: 2px 6px; 
            border-radius: 3px;
        }
        #xss-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>CVE-2020-11022 & CVE-2020-11023 XSS Demonstration</h1>
    
    <div id="xss-indicator">‚ö†Ô∏è XSS TRIGGERED!</div>

    <div class="test-section">
        <h2>üîç √úber diese Schwachstellen</h2>
        <p><strong>CVE-2020-11022</strong> und <strong>CVE-2020-11023</strong> sind XSS-Schwachstellen in jQuery's HTML-Manipulation.</p>
        <p><strong>Betrifft:</strong> jQuery vor Version 3.5.0</p>
        <p><strong>CVSS Score:</strong> 6.1 (Medium)</p>
        <p><strong>Angriffsvektor:</strong> Manipulation von HTML √ºber <code>.html()</code>, <code>.append()</code>, <code>$(html)</code>, etc.</p>
    </div>

    <div class="test-section vulnerable">
        <h2>‚ö†Ô∏è Test 1: Option/Style XSS (CVE-2020-11022)</h2>
        <p>Dieser Angriff nutzt <code>&lt;option&gt;</code> und <code>&lt;style&gt;</code> Tags:</p>
        <div id="vulnerable-test-1"></div>
    </div>

    <div class="test-section fixed">
        <h2>‚úÖ Test 1 Fixed: Option/Style XSS blockiert</h2>
        <div id="fixed-test-1"></div>
    </div>

    <div class="test-section vulnerable">
        <h2>‚ö†Ô∏è Test 2: Self-Closing Tag XSS (CVE-2020-11023)</h2>
        <p>Angriff √ºber gef√§hrliche Self-Closing Tags:</p>
        <div id="vulnerable-test-2"></div>
    </div>

    <div class="test-section fixed">
        <h2>‚úÖ Test 2 Fixed: Self-Closing Tags gefiltert</h2>
        <div id="fixed-test-2"></div>
    </div>

    <div class="test-section">
        <h2>üìã Erkl√§rung der Angriffe</h2>
        
        <h3>Angriff 1: Option/Style Bypass</h3>
        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">
// Malicious HTML:
var evil = '&lt;option&gt;&lt;style&gt;&lt;/option&gt;&lt;/select&gt;&lt;img src=x onerror=alert("XSS")&gt;';

// Vulnerable jQuery code:
$('#target').html(evil);

// Was passiert:
// 1. htmlPrefilter() l√§sst &lt;option&gt;&lt;style&gt; durch
// 2. Browser parst dies fehlerhaft
// 3. &lt;/option&gt; schlie√üt das style Tag nicht richtig
// 4. &lt;img&gt; Tag wird au√üerhalb gerendert
// 5. onerror wird ausgef√ºhrt ‚Üí XSS!
        </pre>

        <h3>Angriff 2: Self-Closing Tag Bypass</h3>
        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">
// Malicious HTML:
var evil = '&lt;style/&gt;&lt;img src=x onerror=alert("XSS")&gt;';

// Vulnerable jQuery code:
$('&lt;div&gt;').html(evil);

// Was passiert:
// 1. htmlPrefilter() konvertiert &lt;style/&gt; zu &lt;style&gt;&lt;/style&gt;
// 2. Aber validiert nicht, ob style √ºberhaupt erlaubt ist
// 3. &lt;img&gt; Tag wird gerendert
// 4. onerror wird ausgef√ºhrt ‚Üí XSS!
        </pre>

        <h3>Der Fix:</h3>
        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">
htmlPrefilter: function( html ) {
    // 1. Erkenne gef√§hrliche Patterns
    if ( rnoInnerhtml.test( html ) && rhtmlPattern.test( html ) ) {
        return "";  // Reject komplett
    }
    
    // 2. Filtere gef√§hrliche Self-Closing Tags
    return html.replace( rxhtmlTag, function( match, tag, tagName ) {
        if ( /^(option|optgroup|select|textarea|title|script|style)$/i.test(tagName) ) {
            return "";  // Strip gef√§hrliche Tags
        }
        return "&lt;" + tag + "&gt;&lt;/" + tagName + "&gt;";
    });
}
        </pre>
    </div>

    <script>
        // Track if XSS was triggered
        window.xssTriggered = false;
        window.triggerXSS = function(testId) {
            window.xssTriggered = true;
            document.getElementById('xss-indicator').style.display = 'block';
            console.error('XSS TRIGGERED in test:', testId);
        };

        // Simulate vulnerable htmlPrefilter (original jQuery 2.2.4)
        function vulnerableHtmlPrefilter(html) {
            var rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi;
            return html.replace(rxhtmlTag, "<$1></$2>");
        }

        // Simulate fixed htmlPrefilter (with CVE fixes)
        function fixedHtmlPrefilter(html) {
            var rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi;
            var rnoInnerhtml = /<script|<style|<link/i;
            var rhtmlPattern = /<option|<optgroup/i;

            // CVE-2020-11022 & CVE-2020-11023 FIX
            if (rnoInnerhtml.test(html)) {
                if (rhtmlPattern.test(html)) {
                    return "";  // Reject dangerous patterns
                }
            }

            var result = html.replace(rxhtmlTag, function(match, tag, tagName) {
                tagName = tagName.toLowerCase();
                var dangerousSelfClose = /^(option|optgroup|select|textarea|title|script|style)$/i;
                if (dangerousSelfClose.test(tagName)) {
                    return "";  // Strip dangerous self-closing tags
                }
                return "<" + tag + "></" + tagName + ">";
            });

            return result;
        }

        // Test 1: Option/Style XSS (CVE-2020-11022)
        function testVulnerable1() {
            var result = '';
            
            // Known XSS vector
            var maliciousHTML = '<option><style></option></select><img src=x onerror=triggerXSS("vuln-1")>';
            
            result += '<div class="result danger">';
            result += '<strong>Malicious HTML:</strong>\n';
            result += maliciousHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>Nach vulnerableHtmlPrefilter():</strong>\n';
            var processed = vulnerableHtmlPrefilter(maliciousHTML);
            result += processed.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>‚ö†Ô∏è WARNUNG:</strong> Dieser Code w√ºrde XSS ausl√∂sen!\n';
            result += '(Wird hier NICHT ausgef√ºhrt aus Sicherheitsgr√ºnden)';
            result += '</div>';
            
            document.getElementById('vulnerable-test-1').innerHTML = result;
        }

        function testFixed1() {
            var result = '';
            
            var maliciousHTML = '<option><style></option></select><img src=x onerror=triggerXSS("fixed-1")>';
            
            result += '<div class="result success">';
            result += '<strong>Malicious HTML:</strong>\n';
            result += maliciousHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>Nach fixedHtmlPrefilter():</strong>\n';
            var processed = fixedHtmlPrefilter(maliciousHTML);
            result += '"' + processed.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '"\n\n';
            result += '<strong>‚úÖ Ergebnis:</strong> Leerer String - Angriff blockiert!\n';
            result += 'Das gef√§hrliche Pattern wurde komplett entfernt.';
            result += '</div>';
            
            document.getElementById('fixed-test-1').innerHTML = result;
        }

        // Test 2: Self-Closing Tag XSS (CVE-2020-11023)
        function testVulnerable2() {
            var result = '';
            
            var maliciousHTML = '<style/><img src=x onerror=triggerXSS("vuln-2")>';
            
            result += '<div class="result danger">';
            result += '<strong>Malicious HTML:</strong>\n';
            result += maliciousHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>Nach vulnerableHtmlPrefilter():</strong>\n';
            var processed = vulnerableHtmlPrefilter(maliciousHTML);
            result += processed.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>‚ö†Ô∏è WARNUNG:</strong> Dieser Code w√ºrde XSS ausl√∂sen!\n';
            result += '(Wird hier NICHT ausgef√ºhrt aus Sicherheitsgr√ºnden)';
            result += '</div>';
            
            document.getElementById('vulnerable-test-2').innerHTML = result;
        }

        function testFixed2() {
            var result = '';
            
            var maliciousHTML = '<style/><img src=x onerror=triggerXSS("fixed-2")>';
            
            result += '<div class="result success">';
            result += '<strong>Malicious HTML:</strong>\n';
            result += maliciousHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '\n\n';
            result += '<strong>Nach fixedHtmlPrefilter():</strong>\n';
            var processed = fixedHtmlPrefilter(maliciousHTML);
            result += '"' + processed.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '"\n\n';
            result += '<strong>‚úÖ Ergebnis:</strong> Self-closing &lt;style/&gt; wurde entfernt!\n';
            result += 'Nur sichere Teile bleiben √ºbrig.';
            result += '</div>';
            
            document.getElementById('fixed-test-2').innerHTML = result;
        }

        // Additional demonstration with safe rendering
        function demonstrateSafe() {
            var demo = document.createElement('div');
            demo.innerHTML = '<div class="result info">';
            demo.innerHTML += '<strong>üí° Sicherer Code:</strong><br>';
            demo.innerHTML += 'Diese Demonstration zeigt die Schwachstellen OHNE sie auszuf√ºhren.<br>';
            demo.innerHTML += 'In der Realit√§t w√ºrden die verwundbaren Versionen tats√§chlich XSS triggern.';
            demo.innerHTML += '</div>';
            document.body.appendChild(demo);
        }

        // Run all tests
        testVulnerable1();
        testFixed1();
        testVulnerable2();
        testFixed2();

        // Check if XSS was triggered
        setTimeout(function() {
            if (!window.xssTriggered) {
                var indicator = document.createElement('div');
                indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #44ff44; color: black; padding: 20px; border-radius: 8px; font-size: 18px; font-weight: bold;';
                indicator.textContent = '‚úÖ Kein XSS ausgel√∂st!';
                document.body.appendChild(indicator);
            }
        }, 1000);
    </script>
</body>
</html>
