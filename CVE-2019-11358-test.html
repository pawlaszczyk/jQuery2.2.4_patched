<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CVE-2019-11358 Prototype Pollution Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 20px;
        }
        .test-section { 
            border: 2px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
        }
        .vulnerable { border-color: #ff4444; background: #fff5f5; }
        .fixed { border-color: #44ff44; background: #f5fff5; }
        h2 { margin-top: 0; }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .danger { background: #f8d7da; color: #721c24; }
        code { 
            background: #f4f4f4; 
            padding: 2px 6px; 
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>CVE-2019-11358 Prototype Pollution Demonstration</h1>
    
    <div class="test-section vulnerable">
        <h2>‚ö†Ô∏è Test 1: Verwundbare Version (Original jQuery 2.2.4)</h2>
        <p>Dieser Test zeigt, wie ein Angreifer √ºber <code>$.extend()</code> den Object-Prototype manipulieren kann:</p>
        <div id="vulnerable-test"></div>
    </div>

    <div class="test-section fixed">
        <h2>‚úÖ Test 2: Gepatchte Version (mit CVE-2019-11358 Fix)</h2>
        <p>Der gleiche Angriff wird vom Fix blockiert:</p>
        <div id="fixed-test"></div>
    </div>

    <div class="test-section">
        <h2>üîç Erkl√§rung der Schwachstelle</h2>
        <p><strong>Was ist Prototype Pollution?</strong></p>
        <p>JavaScript-Objekte erben Properties von <code>Object.prototype</code>. Wenn ein Angreifer 
        <code>Object.prototype</code> modifizieren kann, betrifft das ALLE Objekte in der Anwendung.</p>
        
        <p><strong>Wie funktioniert der Angriff?</strong></p>
        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">
// Angreifer kontrolliert dieses Objekt (z.B. aus JSON):
var maliciousPayload = {
    "__proto__": {
        "isAdmin": true,
        "polluted": "Hacked!"
    }
};

// Vulnerable Code:
$.extend(true, {}, maliciousPayload);

// Jetzt ist JEDES Objekt kompromittiert:
var user = {};
console.log(user.isAdmin);  // true (sollte undefined sein!)
console.log(user.polluted); // "Hacked!"
        </pre>

        <p><strong>Der Fix:</strong></p>
        <p>Der Patch f√ºgt eine √úberpr√ºfung hinzu, die gef√§hrliche Property-Namen blockiert:</p>
        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">
for ( name in options ) {
    // CVE-2019-11358 FIX: Prevent prototype pollution
    if ( name === "__proto__" || 
         name === "constructor" || 
         name === "prototype" ) {
        continue;  // Skip gef√§hrliche Properties!
    }
    // ... rest of extend logic
}
        </pre>
    </div>

    <script>
        // Simulate vulnerable jQuery.extend (original 2.2.4)
        function vulnerableExtend() {
            var options, name, src, copy, copyIsArray, clone,
                target = arguments[0] || {},
                i = 1,
                length = arguments.length,
                deep = false;

            if (typeof target === "boolean") {
                deep = target;
                target = arguments[i] || {};
                i++;
            }

            if (typeof target !== "object" && typeof target !== "function") {
                target = {};
            }

            if (i === length) {
                target = this;
                i--;
            }

            for (; i < length; i++) {
                if ((options = arguments[i]) != null) {
                    // VULNERABLE: No check for __proto__, constructor, prototype
                    for (name in options) {
                        src = target[name];
                        copy = options[name];

                        if (target === copy) {
                            continue;
                        }

                        if (deep && copy && (typeof copy === "object" || Array.isArray(copy))) {
                            if (Array.isArray(copy)) {
                                clone = src && Array.isArray(src) ? src : [];
                            } else {
                                clone = src && typeof src === "object" ? src : {};
                            }
                            target[name] = vulnerableExtend(deep, clone, copy);
                        } else if (copy !== undefined) {
                            target[name] = copy;
                        }
                    }
                }
            }
            return target;
        }

        // Simulate fixed jQuery.extend (with CVE-2019-11358 patch)
        function fixedExtend() {
            var options, name, src, copy, copyIsArray, clone,
                target = arguments[0] || {},
                i = 1,
                length = arguments.length,
                deep = false;

            if (typeof target === "boolean") {
                deep = target;
                target = arguments[i] || {};
                i++;
            }

            if (typeof target !== "object" && typeof target !== "function") {
                target = {};
            }

            if (i === length) {
                target = this;
                i--;
            }

            for (; i < length; i++) {
                if ((options = arguments[i]) != null) {
                    for (name in options) {
                        // CVE-2019-11358 FIX: Prevent prototype pollution
                        if (name === "__proto__" || name === "constructor" || name === "prototype") {
                            continue;
                        }

                        src = target[name];
                        copy = options[name];

                        if (target === copy) {
                            continue;
                        }

                        if (deep && copy && (typeof copy === "object" || Array.isArray(copy))) {
                            if (Array.isArray(copy)) {
                                clone = src && Array.isArray(src) ? src : [];
                            } else {
                                clone = src && typeof src === "object" ? src : {};
                            }
                            target[name] = fixedExtend(deep, clone, copy);
                        } else if (copy !== undefined) {
                            target[name] = copy;
                        }
                    }
                }
            }
            return target;
        }

        // Test 1: Vulnerable version
        function testVulnerable() {
            // Reset prototype (in case of previous pollution)
            delete Object.prototype.isAdmin;
            delete Object.prototype.polluted;

            var result = '';
            
            // Malicious payload
            var maliciousPayload = JSON.parse('{"__proto__":{"isAdmin":true,"polluted":"HACKED!"}}');
            
            // Execute vulnerable extend
            vulnerableExtend(true, {}, maliciousPayload);
            
            // Check if pollution worked
            var testObj = {};
            
            result += '<div class="result danger">';
            result += '<strong>Angriff ausgef√ºhrt:</strong><br>';
            result += 'maliciousPayload = {"__proto__":{"isAdmin":true,"polluted":"HACKED!"}}<br>';
            result += 'vulnerableExtend(true, {}, maliciousPayload);<br><br>';
            result += '<strong>Ergebnis:</strong><br>';
            result += 'var testObj = {};<br>';
            result += 'testObj.isAdmin = ' + testObj.isAdmin + ' ‚ö†Ô∏è (sollte undefined sein!)<br>';
            result += 'testObj.polluted = "' + testObj.polluted + '" ‚ö†Ô∏è (sollte undefined sein!)<br><br>';
            result += '<strong>‚ùå Object.prototype wurde kompromittiert!</strong>';
            result += '</div>';
            
            document.getElementById('vulnerable-test').innerHTML = result;
        }

        // Test 2: Fixed version
        function testFixed() {
            // Reset prototype
            delete Object.prototype.isAdmin;
            delete Object.prototype.polluted;

            var result = '';
            
            // Same malicious payload
            var maliciousPayload = JSON.parse('{"__proto__":{"isAdmin":true,"polluted":"HACKED!"}}');
            
            // Execute fixed extend
            fixedExtend(true, {}, maliciousPayload);
            
            // Check if pollution was prevented
            var testObj = {};
            
            result += '<div class="result success">';
            result += '<strong>Angriff ausgef√ºhrt:</strong><br>';
            result += 'maliciousPayload = {"__proto__":{"isAdmin":true,"polluted":"HACKED!"}}<br>';
            result += 'fixedExtend(true, {}, maliciousPayload);<br><br>';
            result += '<strong>Ergebnis:</strong><br>';
            result += 'var testObj = {};<br>';
            result += 'testObj.isAdmin = ' + testObj.isAdmin + ' ‚úÖ (korrekt: undefined)<br>';
            result += 'testObj.polluted = ' + testObj.polluted + ' ‚úÖ (korrekt: undefined)<br><br>';
            result += '<strong>‚úÖ Angriff wurde blockiert! Object.prototype ist gesch√ºtzt.</strong>';
            result += '</div>';
            
            document.getElementById('fixed-test').innerHTML = result;
        }

        // Run tests
        testVulnerable();
        testFixed();
    </script>
</body>
</html>
